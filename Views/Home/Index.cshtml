@using Microsoft.AspNet.Identity
@using CarMessenger.Models

@{
    var chats = ViewBag.chats as List<KeyValuePair<ChatHead, List<SentMessage>>>;
    //var newChats = ViewBag.newChats ? (ViewBag.newChats as List<String>) : (List<String>());
}
<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<div class="container-fluid h-100">
    <div class="row justify-content-center h-100">
        <div class="col-md-4 col-xl-3 chat">
            <div class="card mb-sm-3 mb-md-0 contacts_card" style="width:200px">
                @*<div class="card-header">
                        <div class="input-group">
                            <input type="text" placeholder="Search..." name="" class="form-control search">
                            <div class="input-group-prepend">
                                <span class="input-group-text search_btn"><i class="fas fa-search"></i></span>
                            </div>
                        </div>
                    </div>*@
                <button class="btn" style="background-color: #C0FFEE"> @Html.ActionLink("New Message", "NewChat")</button>
                <div id="heads_box" class="card-body contacts_body" style="overflow-y: scroll; height:400px;">
                    @{
                        foreach (var chat in chats)
                        {
                            var personNickname = chat.Key.info;
                             <div id="h_@chat.Key.chatId" class="contacts_card chat_head @chat.Key.code @chat.Key.plate @(chat.Key.owning == true ? "Owned" : "")"
                                    style="border: 1px solid; border-color: black" onclick="select_head('@chat.Key.chatId');">
                                (<text class="carCode" st>@chat.Key.code</text>) <strong class="carPlate">@chat.Key.plate</strong>
                                @if (chat.Key.owning)
                                {
                                    if (personNickname != null)
                                    {
                                        <text>(<text class="nickname">@personNickname</text>)</text>
                                    }
                                    else
                                    {
                                        <text><strong> #</strong></text>
                                    }
                                }
                                <text><text class="NewMsgs" style="display: @(chat.Key.newMsgs == 0 ? "none" : "inline")">@chat.Key.newMsgs</text></text>
                            </div>
                        }
                    }
                </div>
                <div class="card-footer"></div>
            </div>
        </div>
        <div id ="chat_box" class="col-md-8 col-xl-6 chat" style="display: none">
            <div class="card">
                <div class="card-header msg_head">
                    <div class="d-flex bd-highlight">
                        <div class="user_info">
                            <span>Chat with : <span id="chat-with-id"></span></span>
                        </div>
                    </div>
                </div>
                <div id="chat_body">
                    @{
                        foreach (var chat in chats)
                        {
                            <div id="b_@chat.Key.chatId" class="card-body msg_card_body contact_body chat_body" style="overflow-y: scroll; height:400px;">
                                @if (chat.Value.Count > 0)
                                {
                                    SentMessage msg;
                                    for (var i = chat.Value.Count - 1; i >= 0; --i)
                                    {
                                        if (i == chat.Key.newMsgs-1)
                                        {
                                            <div class="NUM">
                                                New Unread Messages
                                            </div>
                                        }
                                        msg = chat.Value[i];
                                        <div id="m_@msg.Id" class="messege">
                                            @if (msg.owned)
                                            {
                                                <strong>You</strong>
                                            }
                                            else if ((msg.nickname ?? "") == "")
                                            {
                                                <strong>Anonymus</strong>
                                            }
                                            else
                                            {
                                                <strong class="nickname"> @msg.nickname </strong>
                                                if (!chat.Key.owning)
                                                {
                                                    <text> (<text class="carCode">@chat.Key.code</text>-<text class="carPlate">@chat.Key.plate</text>)</text>
                                                }
                                            }
                                            <text>: @msg.content</text>
                                        </div>
                                    }
                                }
                                @if (chat.Key.newMsgs == 0) // no new messages, but create the objesct
                                {
                                    <div class="NUM" style="display: none">
                                        New Unread Messages
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <div class="input-group-append">
                            <span class="input-group-text attach_btn"><i class="fas fa-paperclip"></i></span>
                        </div>
                        <textarea name="" class="form-control type_msg" id="messageInput" placeholder="Type your message......">
                         </textarea>
                        <div class="input-group-append">
                            <span class="input-group-text send_btn" id="sendButton"><i class="fas fa-location-arrow">Send</i></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="clearfix"></div>
</div>