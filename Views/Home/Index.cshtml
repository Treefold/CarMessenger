@using Microsoft.AspNet.Identity
@using CarMessenger.Models
@*<div class="container">
        <input type="text" id="message" />
        <input type="button" id="sendmessage" value="Send" />
        <input type="hidden" id="displayname" />
        <ul id="discussion">
        </ul>
    </div>*@
@{
    var carsMessages = ViewBag.carsMessages as List<KeyValuePair<(bool owning, string plate, string code), List<Message>>>;
}
<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!------ Include the above in your HEAD tag ---------->
<div class="container-fluid h-100">
    <div class="row justify-content-center h-100">
        <div class="col-md-4 col-xl-3 chat">
            <div class="card mb-sm-3 mb-md-0 contacts_card">
                @*<div class="card-header">
                        <div class="input-group">
                            <input type="text" placeholder="Search..." name="" class="form-control search">
                            <div class="input-group-prepend">
                                <span class="input-group-text search_btn"><i class="fas fa-search"></i></span>
                            </div>
                        </div>
                    </div>*@
                <div id="MessageHeads" class="card-body contacts_body">
                    @{
                        var cnt_h = 0;
                        foreach (var carMessages in carsMessages)
                        {
                            var personMail = carMessages.Value.Count > 0 ? carMessages.Value[0].personMail : null;
                            var id = carMessages.Key.plate + "_" + carMessages.Key.code + "_" + (personMail ?? "");
                            <div id="h_@cnt_h" class="contacts_card contact_head" style="border: 1px solid; border-color: black" onclick="select_head('@cnt_h');">
                                (@carMessages.Key.code) <strong>@carMessages.Key.plate</strong>
                                @if (!carMessages.Key.owning)
                                {
                                    <text>(@(personMail ?? "Anonymous")))</text>
                                }
                            </div>
                            cnt_h += 1;
                        }
                    }
                </div>
                <div class="card-footer"></div>
            </div>
        </div>
        <div id ="chat_box" class="col-md-8 col-xl-6 chat" style="display: none">
            <div class="card">
                <div class="card-header msg_head">
                    <div class="d-flex bd-highlight">
                        <div class="user_info">
                            <span>Chat with : <span id="chat-with-id"></span></span>
                        </div>
                    </div>
                </div>
                @{
                    var vnt_b = 0;
                    foreach (var carMessages in carsMessages)
                    {
                        <div id="b_@vnt_b" class="card-body msg_card_body contact_body">
                            @if(carMessages.Value.Count > 0)
                            {
                                foreach(var msg in carMessages.Value)
                                {
                                    <div class="messege">
                                        @if ((msg.senderEmail ?? "") == "")
                                        {
                                            <strong>Anonymus</strong>
                                        }
                                        else if (msg.senderEmail == User.Identity.GetUserName())
                                        {
                                            <strong>You</strong>
                                        }
                                        else
                                        {
                                            <strong> @msg.senderNickname </strong>
                                            if (msg.senderEmail != msg.personMail)
                                            {
                                                <text>@msg.carCountryCode-@msg.carPlate</text>
                                            }
                                        }
                                        <text>: @msg.content</text>
                                    </div>
                                }
                            }
                        </div>
                        vnt_b += 1;
                    }
                }
                <div class="card-footer">
                    <div class="input-group">
                        <div class="input-group-append">
                            <span class="input-group-text attach_btn"><i class="fas fa-paperclip"></i></span>
                        </div>
                        <textarea name="" class="form-control type_msg" id="messageInput" placeholder="Type your message......">
                         </textarea>
                        <div class="input-group-append">
                            <span class="input-group-text send_btn" id="sendButton"><i class="fas fa-location-arrow"></i></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="clearfix"></div>
</div>

@Scripts.Render("~/Content/messeges.js")

<!--Script references. -->
<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.4.1.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>
<!--Add script to update the page and send messages.-->
<script type="text/javascript">
    $(function () {
        // Declare a proxy to reference the hub.
        var chat = $.connection.chatHub;
        // Create a function that the hub can call to broadcast messages.
        chat.client.broadcastMessage = function (name, message) {
            // Html encode display name and message.
            var encodedName = $('<div />').text(name).html();
            var encodedMsg = $('<div />').text(message).html();
            // Add the message to the page.
            $('#discussion').append('<li><strong>' + encodedName
                + '</strong>:&nbsp;&nbsp;' + encodedMsg + '</li>');
        };
        var nickname = "@User.GetClaimValue("Nickname")";

        if (nickname !== "") {
            // Get the user name and store it to prepend to messages.
            $('#displayname').val(nickname);
        } else {
            $('#displayname').val('Anonymous');
        }
        // Set initial focus to message input box.
        $('#message').focus();
        // Start the connection.
        $.connection.hub.start().done(function () {
            $('#sendmessage').click(function () {
                // Call the Send method on the hub.
                chat.server.send($('#displayname').val(), $('#message').val());
                // Clear text box and reset focus for next comment.
                $('#message').val('').focus();
            });
        });
    });
</script>