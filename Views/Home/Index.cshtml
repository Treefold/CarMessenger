@using Microsoft.AspNet.Identity
@using CarMessenger.Models

@{
    var chats = ViewBag.chats as List<KeyValuePair<ChatHead, List<SentMessage>>>;
    //var newChats = ViewBag.newChats ? (ViewBag.newChats as List<String>) : (List<String>());
}
<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!------ Include the above in your HEAD tag ---------->
<div class="container-fluid h-100">
    <div class="row justify-content-center h-100">
        <div class="col-md-4 col-xl-3 chat">
            <div class="card mb-sm-3 mb-md-0 contacts_card" style="width:200px">
                @*<div class="card-header">
                        <div class="input-group">
                            <input type="text" placeholder="Search..." name="" class="form-control search">
                            <div class="input-group-prepend">
                                <span class="input-group-text search_btn"><i class="fas fa-search"></i></span>
                            </div>
                        </div>
                    </div>*@
                <button class="btn" style="background-color: #C0FFEE"> @Html.ActionLink("New Message", "NewChat")</button>
                <div id="heads_box" class="card-body contacts_body" style="overflow-y: scroll; height:400px;">
                    @{
                        foreach (var chat in chats)
                        {
                            var personNickname = chat.Key.info;
                             <div id="h_@chat.Key.chatId" class="contacts_card chat_head @chat.Key.code @chat.Key.plate @(chat.Key.owning == true ? "Owned" : "")"
                                    style="border: 1px solid; border-color: black" onclick="select_head('@chat.Key.chatId');">
                                (<text class="carCode" st>@chat.Key.code</text>) <strong class="carPlate">@chat.Key.plate</strong>
                                @if (chat.Key.owning)
                                {
                                    if (personNickname != null)
                                    {
                                        <text>(<text class="nickname">@personNickname</text>)</text>
                                    }
                                    else
                                    {
                                        <text><strong> #</strong></text>
                                    }
                                }
                                <text><text class="NewMsgs" style="display: @(chat.Key.newMsgs == 0 ? "none" : "inline")">@chat.Key.newMsgs</text></text>
                            </div>
                        }
                    }
                </div>
                <div class="card-footer"></div>
            </div>
        </div>
        <div id ="chat_box" class="col-md-8 col-xl-6 chat" style="display: none">
            <div class="card">
                <div class="card-header msg_head">
                    <div class="d-flex bd-highlight">
                        <div class="user_info">
                            <span>Chat with : <span id="chat-with-id"></span></span>
                        </div>
                    </div>
                </div>
                <div id="chat_body">
                    @{
                        foreach (var chat in chats)
                        {
                            <div id="b_@chat.Key.chatId" class="card-body msg_card_body contact_body chat_body" style="overflow-y: scroll; height:400px;">
                                @if (chat.Value.Count > 0)
                                {
                                    SentMessage msg;
                                    for (var i = chat.Value.Count - 1; i >= 0; --i)
                                    {
                                        if (i == chat.Key.newMsgs-1)
                                        {
                                            <div class="NUM">
                                                New Unread Messages
                                            </div>
                                        }
                                        msg = chat.Value[i];
                                        <div id="m_@msg.Id" class="messege">
                                            @if (msg.owned)
                                            {
                                                <strong>You</strong>
                                            }
                                            else if ((msg.nickname ?? "") == "")
                                            {
                                                <strong>Anonymus</strong>
                                            }
                                            else
                                            {
                                                <strong class="nickname"> @msg.nickname </strong>
                                                if (!chat.Key.owning)
                                                {
                                                    <text> (<text class="carCode">@chat.Key.code</text>-<text class="carPlate">@chat.Key.plate</text>)</text>
                                                }
                                            }
                                            <text>: @msg.content</text>
                                        </div>
                                    }
                                }
                                @if (chat.Key.newMsgs == 0) // no new messages, but create the objesct
                                {
                                    <div class="NUM" style="display: none">
                                        New Unread Messages
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <div class="input-group-append">
                            <span class="input-group-text attach_btn"><i class="fas fa-paperclip"></i></span>
                        </div>
                        <textarea name="" class="form-control type_msg" id="messageInput" placeholder="Type your message......">
                         </textarea>
                        <div class="input-group-append">
                            <span class="input-group-text send_btn" id="sendButton"><i class="fas fa-location-arrow">Send</i></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="clearfix"></div>
</div>

<!--Script references. -->
<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.4.1.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>
<!--Add script to update the page and send messages.-->
<script type="text/javascript">
    var _selectedChatId = undefined;

    function getCarPlate(headId) {

        return $("#" + headId + " .carPlate")[0].innerHTML;
    }

    function getCarCode(headId) {
        return $("#" + headId + " .carCode")[0].innerHTML;
    }

    function getOwned(headId) {
        return $("#" + headId).hasClass("Owned");
    }

    function getNickname(headId) {

        var maybeNickname =  $("#" + headId + " .nickname");
        return maybeNickname.length == 0 ? null : maybeNickname[0].innerHTML;
    }

    function getContent() {
        // return $('#messageInput').val(); // faulty - keeps html tags
        return (new DOMParser().parseFromString($('#messageInput').val(), 'text/html')).body.textContent;
    }

    function resetContent(cnt = '') {
        $('#messageInput').val(cnt);
    }

    function getLastMsgs(chatId) {
        var msgArr = $("#b_" + chatId + " .messege:last");
        if (msgArr.length > 0) {
            var msgId = msgArr.attr('id').substring(2);
            return msgId;
        }
        return null;
    }

    function select_head(id) {
        // for the old chat
        if (_selectedChatId) { // if there was a previous chat
            var oldHeadNewMsgs = $("#h_" + _selectedChatId + " .NewMsgs");
            if (oldHeadNewMsgs[0].innerHTML == 0) { // all messages were read
                $("#b_" + _selectedChatId + " .NUM").css('display', 'none') // hide new messages banner
            }
        }

        // for the new chat
        _selectedChatId = id;
        resetContent()
        $(".chat_head").css('background-color', '#FFF');
        $("#h_" + id).css('background-color', "#C0FFEE");
        $('#chat-with-id').html($("#h_" + id).html());
        $(".contact_body").css('display', 'none');
        $("#chat_box").css('display', 'block');
        $("#b_" + id).css('display', 'block');
        $("#b_" + id).scrollTop($("#b_" + id)[0].scrollHeight);

        var headNewMsgs = $("#h_" + id + " .NewMsgs");
        headNewMsgs.css('display', 'none');
        headNewMsgs[0].innerHTML = "0";
    }

    $(document).ready(function () {
        // notifications test
        //Notification.requestPermission().then(permision => {
        //    new Notification("CarMessanger", {body: "Test Notificationswd"});
        //})

        // all server functions have the first letter lowered

        // Declare a proxy to reference the hub.
        var chat = $.connection.chatHub;
        var userId = "@User.Identity.GetUserId()";
        var nickname = "@User.GetClaimValue("Nickname")";

        function addMessage(chatId, msgId, nickname, msg, mine = false) {
            // move chat head
            var el = $("#h_" + chatId);
            //$("#h_" + chatId).remove();
            $("#heads_box").prepend(el);

            var readMsg = mine;
            if (!mine) {
                if (chatId == _selectedChatId) { // new message in the current chat
                    var currChatbox = $("#b_" + chatId);
                    var chatboxHeight = $("#chat_body").height();
                    if (currChatbox.scrollTop() + chatboxHeight >= currChatbox[0].scrollHeight) {
                        //console.log("this message was read")
                        readMsg = true;
                    }
                }
                var headNewMsgs = $("#h_" + chatId + " .NewMsgs");
                if (!readMsg) {
                    // update new messages counter
                    headNewMsgs.css('display', 'inline');
                    if (headNewMsgs[0].innerHTML == 0) { // First new message
                        var NUM = $("#b_" + chatId + " .NUM");
                        //$("#b_" + chatId + " .NUM")[0].remove();
                        $("#b_" + chatId).append(NUM);
                        NUM.css("display", "inline");
                    }
                    headNewMsgs[0].innerHTML -= -1; // adds 1 to string - js hack :)

                    // add notification if message was not read
                    //new Notification("CarMessanger", { body: "New Message in: " +});
                    notMsgComp = el.children();
                    notificationMsg = "New Message in chat: " + notMsgComp[0].innerHTML + " " + notMsgComp[1].innerHTML + (notMsgComp.length > 3 ? (" " + notMsgComp[2].innerHTML) : "");
                    Notification.requestPermission().then(permision => {
                        new Notification("CarMessanger", { body: notificationMsg });
                    });
                }
                else {
                    // remove unreadcounter 
                    headNewMsgs[0].innerHTML = 0;
                    headNewMsgs.css('display', 'none');
                    // remove last read marker
                    $("#b_" + chatId + " .NUM").css("display", "none");
                }
            }

            $("#b_" + chatId).append('<div id="m_' + msgId + '" class="messege"><strong class="nickname">' + nickname + '</strong><text> : ' + msg + '</text></div>');

            if (readMsg) {
                var currChatbox = $("#b_" + chatId);
                currChatbox.scrollTop(currChatbox[0].scrollHeight*2);
                if (!mine) {
                    chat.server.newSeen(userId, chatId, msgId)
                }
            }
        }

        // Create a function that the hub can call to broadcast messages.
        chat.client.broadcastMessage = function (name, message) {
            console.log(name + ": " + message);
        };
        chat.client.addMessage = function (msgJson) {
            var msg = jQuery.parseJSON(msgJson);
            //var id = $("." + msg.carCountryCode + "." + msg.carPlate)[0].id.replace('h_', '');
            addMessage(msg.chatId, msg.Id, msg.nickname, msg.content);
        };
        chat.client.DeleteChat = function (chatId) {
            var chatH = $("#h_" + chatId)[0];
            var chatB = $("#b_" + chatId)[0];
            var warningMsgEl = $(
                '<div class="alert warning"> \
                    <span class="closebtn" onclick="this.parentElement.style.display=\'none\';">&times;</span> \
                    <strong>Well... </strong> The "'
                + chatH.innerHTML
                + '" Chat was removed by the Car Owner</div>')[0];
            $('#Msgs')[0].append(warningMsgEl);

            chatH.remove();
            chatB.remove();

            if (chatId == _selectedChatId) {
                resetContent()
                $("#chat_box").css('display', 'none');
                _selectedChatId = undefined;
            }
        };
        chat.client.UpdateCarChat = function (chatId, plate, code) {
            $("#h_" + chatId + " .carPlate")[0].innerHTML = plate;
            $("#h_" + chatId + " .carCode")[0].innerHTML = code;

            $("#b_" + chatId + " .carPlate").each((ind, el) => el.innerHTML = plate);
            $("#b_" + chatId + " .carCode").each((ind, el) => el.innerHTML = code);
        };
        chat.client.UpdateNickChat = function (chatId, nick) {
            var els = $("#h_" + chatId + " .nickname")
            if (els.length > 0)
                els[0].innerHTML = nick;
        };
        chat.client.UpdateNickMsg = function (chatId, nick, msgIdList) {
            //for (var idx in msgIdList) {
            //    var els = $("#b_" + chatId + " #m_" + msgIdList[idx] + " .nickname")
            //    if (els.length > 0)
            //        els[0].innerHTML = nick;
            //}
            msgIdList.forEach((msgId) => {
                var els = $("#b_" + chatId + " #m_" + msgId + " .nickname")
                if (els.length > 0)
                    els[0].innerHTML = nick;
            });
        };
        chat.client.AddChat = function (newChat) {
            if ($("#h_" + newChat.chatId).length > 0) return; // error already exists
            $("#heads_box").prepend(
                '<div id="h_' + newChat.chatId
                + '" class="contacts_card chat_head ' + newChat.plate + " " + newChat.code + (newChat.owned == true ? " Owned" : "") + '" style="border: 1px solid; border-color: black">'
                + '(<text class="carCode">' + newChat.code + '</text>) <strong class="carPlate">' + newChat.plate + '</strong> '
                + ((newChat.owning == false) ? ('') : (
                        (newChat.info != null) ? (
                            '<text>(<text class="nickname">' + newChat.info + '</text>)</text>'
                        ) : (
                                '<text><strong>#</strong></text>'
                        )
                )) + '</div>'
            );
            var id = newChat.chatId;
            $("#h_" + newChat.chatId).click(function () { select_head(id); });
            $("#chat_body").append(
                '<div id="b_' + newChat.chatId + '" class="card-body msg_card_body contact_body chat_body" style="overflow-y: scroll; height:400px;">'
                + '</div>'
            );
            chat.server.joinNewChat(newChat.chatId);
        }

        // Start the connection.
        $.connection.hub.start().done(function () {

            chat.server.joinMyChats()
            chat.server.joinMyCars(userId);

            $('#messageInput').val('').focus();

            $("#messageInput").click(function () {
               
                var headNewMsgs = $("#h_" + _selectedChatId + " .NewMsgs");
                headNewMsgs.css('display', 'none');
                headNewMsgs[0].innerHTML = "0";

                $("#b_" + _selectedChatId + " .NUM").css('display', 'none');

                
                if (_selectedChatId) {
                    var msgId = getLastMsgs(_selectedChatId);
                    if (msgId) {
                        chat.server.newSeen(userId, _selectedChatId, msgId);
                    }
                }
            });


            function send() {
                if (getContent() === "") {
                    $('#messageInput').focus();
                    return;
                }
                var id = "h_" + _selectedChatId;
                var owned = getOwned(id);

                var headNewMsgs = $("#h_" + _selectedChatId + " .NewMsgs");
                headNewMsgs.css('display', 'none');
                headNewMsgs[0].innerHTML = "0";

                $("#b_" + _selectedChatId + " .NUM").css('display', 'none')

                addMessage(_selectedChatId, "", "You", getContent(), true);
                //$("#b_" + _selectedChatId).scrollTop($("#b_" + _selectedChatId)[0].scrollHeight);

                chat.server.messageChat(_selectedChatId, userId, nickname, getContent())
                $('#messageInput').val('').focus();
            }

            $('#sendButton').click(send);
            $("#messageInput").keyup(function (event) {
                if (event.keyCode === 13) { // enter
                    send();
                }
            });

            $('div.chat_head').click(function (event) {
                var e = $(event.currentTarget);
                if (!e.is('div')) return;
                var chatId = e.attr('id').substring(2);
                var lastMsgId = getLastMsgs(chatId);
                if (lastMsgId) {
                    chat.server.newSeen(userId, chatId, lastMsgId);
                }
            });
        });
    });
</script>